name: Test

inputs:
  server-tag:
    required: false
    default: latest
    description: Server docker image tag
  oidc-provider:
    required: true
    description: OIDC provider
  oidc-audience:
    required: true
    description: OIDC audience
  server-type:
    required: true
    description: Server type `aerospike-server` or `aerospike-server-enterprise`
  strong-consistency:
    required: false
    default: "1"
    description: Enable strong consistency (`1` or `0`)
  server-image:
    required: false
    default: ""
    description: Custom full docker image name (overrides server-tag and server-type)

runs:
  using: composite
  steps:
    - name: Run EE server
      uses: ./.github/actions/run-ee-server
      with:
        server-tag: ${{ inputs.server-tag }}
        server-type: ${{ inputs.server-type }}
        server-image: ${{ inputs.server-image }}
        oidc-provider: ${{ inputs.oidc-provider }}
        oidc-audience: ${{ inputs.oidc-audience }}
        strong-consistency: ${{ inputs.strong-consistency }}

    - name: Download test artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        name: AerospikeTest-${{ github.run_number }}
        path: artifacts

    - name: Unzip tests
      shell: bash
      working-directory: artifacts
      run: unzip AerospikeTest*.zip

    - name: Test
      shell: bash
      run: dotnet exec ./artifacts/publish/AerospikeTest.dll --settings ./.runsettings

    - name: Show logs if failed
      shell: bash
      if: ${{ failure() }}
      run: |
        docker container logs aerospike
