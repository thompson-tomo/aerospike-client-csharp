name: Build and test stage
run-name: Build artifacts and run stage tests (${{ inputs.server-image && format('server-image={0}', inputs.server-image) || format('server-tag={0}', inputs.server-tag || 'latest') }})

permissions:
  # This is required for requesting the OIDC token
  id-token: write
  contents: read

# Trigger test workflow whenever:
# Pushes to stage branch
on:
  push:
    branches: ["stage"]
  workflow_dispatch:
    inputs:
      server-tag:
        type: string
        required: false
        default: 'latest'
        description: 'Server docker image tag'
      server-type:
        type: string
        required: false
        default: 'aerospike-server-enterprise'
      server-image:
        type: string
        required: false
        default: ''
        description: 'Custom full docker image name (e.g., aerospike.jfrog.io/database-docker-virtual/aerospike-server-enterprise:8.1.1.0-rc27_1). Overrides server-tag and server-type if provided.'

jobs:
  build:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
      with:
        egress-policy: audit

    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    - name: Setup .NET
      uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
      with:
        dotnet-version: 8.0.x
    - name: Build artifacts
      uses: ./.github/actions/build
      with:
        sgKey: ${{ secrets.SG_KEY }}
    - name: Get version from nupkg
      id: get-version
      shell: pwsh
      run: |
        $nupkg = Get-ChildItem -Path AerospikeClient\bin\Release -Filter "Aerospike.Client.*.nupkg" | Where-Object { $_.Extension -eq ".nupkg" } | Select-Object -First 1
        $version = $nupkg.BaseName -replace '^Aerospike\.Client\.', ''
        echo "version=$version" >> $env:GITHUB_OUTPUT

  sign:
    needs: build
    uses: aerospike/shared-workflows/.github/workflows/reusable_sign-artifacts.yaml@v3.0.0
    with:
      gh-unsigned-artifacts: AerospikeClient-${{ github.run_number }}
      gh-workflows-ref: v3.0.0
    secrets:
      gpg-private-key: ${{ secrets.GPG_SECRET_KEY }}
      gpg-public-key: ${{ secrets.GPG_PUBLIC_KEY }}
      gpg-key-pass: ${{ secrets.GPG_PASS }}
      es-username: ${{ secrets.ES_USERNAME }}
      es-password: ${{ secrets.ES_PASSWORD }}
      credential_id: ${{ secrets.CREDENTIAL_ID }}
      es-totp_secret: ${{ secrets.ES_TOTP_SECRET }}

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
      with:
        egress-policy: audit

    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    - name: Test
      uses: ./.github/actions/test
      with:
        server-tag: ${{ inputs.server-tag || 'latest' }}
        server-type: ${{ inputs.server-type || 'aerospike-server-enterprise' }}
        server-image: ${{ inputs.server-image || '' }}
        oidc-provider: database-gh-aerospike
        oidc-audience: database-gh-aerospike

  deploy:
    needs: [build, sign, test]
    uses: aerospike/shared-workflows/.github/workflows/reusable_deploy-artifacts.yaml@v3.0.0
    with:
      jf-project: database
      jf-build-name: aerospike-client-csharp
      jf-build-id: ${{ github.run_id }}
      jf-metadata-build-id: ${{ github.run_id }}-metadata
      version: ${{ needs.build.outputs.version }}
      gh-artifact-name: signed-artifacts
      gh-workflows-ref: v3.0.0
      oidc-provider-name: database-gh-aerospike
      oidc-audience: database-gh-aerospike

  deploy-test:
    needs: [build, test]
    uses: aerospike/shared-workflows/.github/workflows/reusable_deploy-artifacts.yaml@v3.0.0
    with:
      jf-project: database
      jf-build-name: aerospike-client-csharp-tests
      jf-build-id: ${{ github.run_id }}-tests
      jf-metadata-build-id: ${{ github.run_id }}-tests-metadata
      version: ${{ needs.build.outputs.version }}
      gh-artifact-name: AerospikeTest-${{ github.run_number }}
      gh-workflows-ref: v3.0.0
      oidc-provider-name: database-gh-aerospike
      oidc-audience: database-gh-aerospike

  create-release-bundle:
    needs: [build, deploy]
    uses: aerospike/shared-workflows/.github/workflows/reusable_create-release-bundle.yaml@v3.0.0
    with:
      jf-project: database
      jf-build-names: "aerospike-client-csharp:${{ github.run_id }}"
      jf-bundle-name: aerospike-client-csharp
      version: ${{ needs.build.outputs.version }}
      gh-workflows-ref: v3.0.0
      oidc-provider-name: database-gh-aerospike
      oidc-audience: database-gh-aerospike
